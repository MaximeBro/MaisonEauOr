@using System.ComponentModel
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthStateProvider
@inject BasketService BasketService

<header>
    <MudStack Justify="Justify.SpaceBetween" Row="true" AlignItems="AlignItems.Center" Class="flex-wrap">
        <div class="d-flex justify-content-start flex-1">
            <MudIconButton Icon="@_burger" Color="Color.Dark" Size="Size.Large" OnClick="@Toggle" id="burger"/>
        </div>
        <MudLink Href="/">
            <MudImage Src="images/logo.png" Alt="Maison Eau D'or" Height="76"></MudImage>
        </MudLink>
        <div id="toolbar" class="d-flex justify-content-end flex-1">
            <MudToolBar>
                <AuthorizeView Roles="Admin">
                    <Authorized>
                        <MudIconButton Icon="@Icons.AdminPanelSettings" Color="Color.Secondary" Class="ml-4" Href="/admin-panel"/>
                    </Authorized>
                </AuthorizeView>
                <MudIconButton Icon="@Icons.Search" Color="Color.Dark"/>
                <MudIconButton Icon="@Icons.Person" Color="Color.Dark" OnClick="@CheckUserSession"/>
                <MudIconButton OnClick="@(async() => await ToggleDrawer())" Icon="@Icons.ShoppingCart" Color="Color.Dark"/>
            </MudToolBar>
        </div>
    </MudStack>
    <nav style="@_style" class="navbar">
        <div class="dropdown-div">
            <button onclick="@(() => Open(0))" class="dropbtn">
                Parfums
                <i class="fa fa-caret-down"></i>
            </button>
            <div class="dropdown-content @(_isOpen[0] ? "show" : "")">
                <a href="/catalog-perfumes">Le Bar à parfums</a>
                <a href="/catalog-gourmets">Les Evasions Gourmandes</a>
            </div>
        </div>
        <a href="/catalog-homes">Maison</a>
        <a href="/catalog-musks">Muscs Tahara intime</a>
        <a href="/catalog-cosmetics">Cosmétiques</a>
        <a href="/catalog-mists">Brumes</a>
        <a href="/catalog-hairproducts">Produits capillaire</a>
    </nav>
    <BasketDrawer @ref="_drawer"/>
</header>

@code
{
    private UserSession? _currentUser;
    private BasketDrawer _drawer = new();

    private bool[] _isOpen = new bool[3];
    private string _burger = Icons.Menu;
    private string? _style;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authService = (AuthenticationService)AuthStateProvider;
            _currentUser = await authService.GetCurrentUserAsync();
            _drawer.CurrentUser = _currentUser;
        }
    }

    public async Task RefreshUserSession()
    {
        if (AuthStateProvider != null)
        {
            var authService = (AuthenticationService)AuthStateProvider;
            _currentUser = await authService.GetCurrentUserAsync();
            _drawer.CurrentUser = _currentUser;
        }
    }

    private void CheckUserSession()
    {
        if (_currentUser != null && _currentUser.Role != UserRole.Guest)
        {
            NavManager.NavigateTo("/profile");
        }
        else
        {
            NavManager.NavigateTo("/signin");
        }
    }

    private async Task ToggleDrawer(bool toggle = true)
    {
        await _drawer.ToggleDrawer(toggle);
    }

    private void Open(int num)
    {
        for (int i = 0; i < _isOpen.Length; i++)
        {
            _isOpen[i] = (i == num && !_isOpen[i]);
        }
    }

    private void Toggle()
    {
        if (_burger == Icons.Menu)
        {
            _burger = Icons.Close;
            _style = "display:flex;";
        }
        else
        {
            _burger = Icons.Menu;
            _style = "";
        }
    }
}