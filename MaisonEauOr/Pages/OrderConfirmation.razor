@page "/order/{OrderId:guid}"

@inject IDbContextFactory<MeoDbContext> Factory
@inject AuthenticationStateProvider AuthStateProvider
@inject MailerService MailerService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

@if (_order is null)
{
    <MudStack Row Justify="Justify.Center">
        <MudProgressCircular Color="Color.Primary" Indeterminate/>
    </MudStack>
    return;
}

<PageTitle>Maison eau d'or - Page de paiement</PageTitle>

<MudContainer Class="mb-16">
    <MudText Typo="Typo.h3">Confirmation de commande</MudText>
    <MudStack Class="d-flex justify-content-between">
        <MudStack>
            <MudExpansionPanel Text="1. Contact">
                <MudText Typo="Typo.body2" Style="@($"color:{Colors.Grey.Default};")">Uniquement à des fin de facturation et de commande</MudText>
                <MudTextField T="string" InputType="InputType.Text" Label=" Nom complet" Variant="Variant.Outlined"></MudTextField>
                <MudTextField T="string" InputType="InputType.Email" Label="E-mail" Variant="Variant.Outlined"></MudTextField>
                <MudTextField T="string" InputType="InputType.Telephone" Label="Numéro de téléphone" Variant="Variant.Outlined"></MudTextField>
                <MudButton Class="mt-3" Variant="Variant.Filled" Color="Color.Dark">Continuer</MudButton>
            </MudExpansionPanel>

            <MudExpansionPanel Text="2. Mode de livraison">
                <MudTextField T="string" Label="Nom complet" Variant="Variant.Outlined"></MudTextField>
                <MudStack>
                    <MudTextField T="string" Label="Rue" Variant="Variant.Outlined"></MudTextField>
                    <MudTextField T="string" Label="Numéro" Variant="Variant.Outlined"></MudTextField>
                </MudStack>
                <MudStack>
                    <MudTextField T="string" Label="Ville" Variant="Variant.Outlined"></MudTextField>
                    <MudTextField T="string" Label="Code postal" Variant="Variant.Outlined"></MudTextField>
                </MudStack>
                <MudTextField T="string" Label="Pays" Variant="Variant.Outlined"></MudTextField>
                <MudButton Class="mt-3" Variant="Variant.Filled" Color="Color.Dark">Continuer</MudButton>
            </MudExpansionPanel>

            <MudExpansionPanel Text="3. Moyen de paiement">
                <MudRadioGroup @bind-SelectedOption="@_selectedOption">
                    <MudRadio Option="@("CB")" Color="Color.Dark"><MudIcon Icon="@Icons.CreditCard"/> CB</MudRadio>
                    <MudRadio Class="mx-4" Option="@("PAYPAL")" Color="Color.Dark"><MudIcon Icon="fab fa-paypal"/> Paypal</MudRadio>
                    <MudRadio Option="@("IPAY")" Color="Color.Dark"><MudIcon Icon="@IconsC.Brands.Apple"/> Ipay</MudRadio>
                </MudRadioGroup>
                @switch (_selectedOption)
                {
                    case "CB":
                    {
                        <MudText Class="mt-3" Typo="Typo.body1">Payer avec Carte de crédit/débit</MudText>
                        <MudTextField T="string" Label="Nom sur la carte" Variant="Variant.Outlined"></MudTextField>
                        <MudGrid Style="max-width: 400px;" Justify="Justify.SpaceBetween">
                            <MudItem xs="12">
                                <MudTextField T="string" Mask="@(new PatternMask("0000 0000 0000 0000"))" Label="Numéro de carte bancaire"
                                              Variant="@Variant.Text" Clearable/>
                            </MudItem>
                            <MudItem xs="5">
                                <MudTextField T="DateTime?" Mask="@(new DateMask("MM/YY", 'Y', 'M'))" Label="Date d'expiration"
                                              Variant="@Variant.Text"/>
                            </MudItem>

                            <MudItem xs="4">
                                <MudTextField T="int" Mask="@(new PatternMask("000"))" Label="Cryptogramme" Placeholder="CVC" Variant="@Variant.Text"/>
                            </MudItem>
                            <MudItem xs="12">
                                <MudTextField Class="mt-4" T="string" Label="Code Promo" Variant="Variant.Outlined" Clearable Adornment="Adornment.Start" AdornmentIcon="@Icons.Discount"/>
                            </MudItem>
                        </MudGrid>
                        break;
                    }
                    case "PAYPAL":
                    {
                        <MudStack Row Justify="Justify.Center">
                            <MudButton Class="py-3 px-12" Variant="Variant.Filled" Color="Color.Warning" Style="color: #000;">
                                Payer avec Paypal
                                <MudIcon Class="ml-4" Icon="fab fa-cc-paypal" Style="color: #0079C1!important;"/>
                            </MudButton>
                        </MudStack>
                        break;
                    }
                    case "IPAY":
                    {
                        <MudStack Row Justify="Justify.Center">
                            <MudButton Class="py-3 px-12" Variant="Variant.Filled" Color="Color.Dark" Style="color: #fff;">
                                Payer avec Apple Pay
                                <MudIcon Class="ml-4" Icon="fab fa-cc-apple-pay" Style="color: #fff;"/>
                            </MudButton>
                        </MudStack>
                        break;
                    }
                }
            </MudExpansionPanel>
            <MudText Typo="Typo.body1">
                En continuant vous accepter nos
                <MudLink Color="Color.Dark" Underline="Underline.Always" Href="/terms-and-conditions">conditions générales de vente.</MudLink>
            </MudText>
            <MudCheckBox T="bool" Label="J'accepte le traitement de mes données par Maison d'eau D'or à des fins marketing."></MudCheckBox>
            <MudButton Class="mt-3" Variant="Variant.Filled" Color="Color.Dark" OnClick="@(async () => await SetOrderStatus())">
                Payer @_order.Total.ToString("C")
            </MudButton>
        </MudStack>
    </MudStack>
</MudContainer>


@code {
    [Parameter]
    public Guid OrderId { get; set; }

    private MeoDbContext _context = null!;
    private UserSession? _currentUser;
    private OrderModel? _order;
    private List<BasketProductModel> _products = new();

    private bool _sending;
    
    private string _selectedOption = "CB";
    private string _email = "maimemail.brochard.com@gmail.com";

    protected override async Task OnInitializedAsync()
    {
        _context = await Factory.CreateDbContextAsync();
        _order = _context.Orders.FirstOrDefault(x => x.Id == OrderId);
        if (_order is null)
        {
            Snackbar.Add("Une erreur est survenue, redirection en cours...", Severity.Error);
            NavManager.NavigateTo("/");
            StateHasChanged();
        }
        else
        {
            _products = _context.BasketProducts.Include(x => x.Product).Where(x => x.OrderID == _order.Id).ToList();
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authService = (AuthenticationService)AuthStateProvider;
            _currentUser = await authService.GetCurrentUserAsync();
        }
    }

    private async Task SetOrderStatus()
    {
        if (_order is null)
        {
            Snackbar.Add("Une erreur est survenue, redirection en cours...", Severity.Error);
            NavManager.NavigateTo("/");
            StateHasChanged();
        }
        else
        {
            if (_order.Payed)
            {
                Snackbar.Add("Votre commande a déjà été validée !", Severity.Info);
                NavManager.NavigateTo("/user-profile");
                return;
            }
            Snackbar.Add("Validation de la commande en cours...", Severity.Success);
            _order.Payed = true;
            _context.Orders.Update(_order);
            await _context.SaveChangesAsync();
            
            var recipient = _currentUser?.Email ?? _email;
            var mailBody = $"Bonjour,\nVote commande #{_order.Id} d'un montant de {_order.Total.ToString("C")} vient d'être validée et sera prise en compte d'ici peu par nos équipes.\nNous vous remercions pour vos achats chez Maison Eau D'or et espérons vous retrouver très vite.";
            var recap = string.Empty;
            foreach (var product in _products)
            {
                recap += $"{product.Product!.Name} {product.TotalPrice}\n";
            }
            mailBody += recap;
            _sending = true;
            await MailerService.SendEmailAsync(recipient, $"Confirmation de votre commande #{_order.Id}", mailBody);
            _sending = false;
            NavManager.NavigateTo("/user-profile");
        }
    }
}