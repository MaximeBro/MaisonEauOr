@page "/"

@inject IDbContextFactory<MeoDbContext> Factory
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Maison eau d'or</PageTitle>

<MudContainer Class="mt-10 px-0" MaxWidth="MaxWidth.ExtraExtraLarge">
    <MudStack Row>
        <MudImage Style="width: 100vw;" Src="images/home/bar.png"/>
    </MudStack>
    <MudText Class="my-8" Style="color: #ECC291!important;" Typo="Typo.h2" Align="Align.Center">Nos meilleures ventes</MudText>

</MudContainer>


@code {
    private MeoDbContext _context = null!;

    protected override async Task OnInitializedAsync()
    {
        _context = await Factory.CreateDbContextAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var authService = (AuthenticationService)AuthStateProvider;
            var defaultSession = new UserSession
                {
                    Identifier = Guid.NewGuid(),
                    Role = UserRole.Guest,
                    UserName = string.Empty
                };
            await authService.UpdateAuthentificationState(defaultSession);
            if (_context.UserAccounts.All(x => x.Email != "root@admin.meo"))
            {
                _context = await Factory.CreateDbContextAsync();
                _context.UserAccounts.Add(new UserAccount
                {
                    Email = "root@admin.meo",
                    Password = BC.HashPassword("toor")
                });
                await _context.SaveChangesAsync();
            }
        }        
    }
}